<!doctype html>
<html lang="sv">
<head>
  <meta charset="utf-8" />
  <title>Geoguessr - The Nabo Way - Minimal (bearing + sticky hint)</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
  <style>
    :root{
      --brand-600: #5e725e;
      --brand-700: #4d6151;
      --brand-800: #3e4f42; /* Nabo-grön */
      --beige:     #f3efe5;
      --txt-muted: #cfd5c8;
      --font-body: Calibri,'Segoe UI',system-ui,-apple-system,Roboto,Helvetica,Arial,sans-serif;
      --radius: 12px;
    }
    html, body, #app { height: 100%; margin: 0; }
    body { font-family: var(--font-body); background: var(--beige); }

    /* ➕ bredare högerspalt (från 420px → 520px) */
    #app { display: grid; grid-template-columns: minmax(0,1fr) 520px; grid-template-rows: auto 1fr; }

    header{ grid-column:1/3; display:flex; justify-content:space-between; align-items:center;
      padding:10px 14px; background: var(--brand-700); color: var(--beige); }
    #map{ height: calc(100vh - 52px); }
    .panel{ background: var(--brand-700); color: var(--beige); height: calc(100vh - 52px); overflow:auto; }
    .box{ padding:14px 16px; border-bottom: 1px solid rgba(255,255,255,.1); }
    .hint{ color: var(--txt-muted); }
    .float-info{ position: fixed; top: 70px; left: 50%; transform: translateX(-50%);
      background: var(--brand-700); color: var(--beige); padding: 12px 16px; border-radius: 10px;
      z-index: 5000; }
    .toolbar{ display:flex; gap:10px; justify-content:center; margin-top:8px; }
    .toolbar button{ background: transparent; border:1px solid rgba(255,255,255,.5); color: var(--beige); padding:8px 12px; border-radius:8px; cursor:pointer; }
    .overlay{ position: fixed; inset:0; display:flex; align-items:center; justify-content:center; background: rgba(255,255,255,.9); z-index: 6000; }

    /* ★ Ny större kort-layout för VÄLJ STAD */
    .card{
      background: var(--brand-700);
      color: var(--beige);
      width: min(92vw, 820px);
      max-width: 820px;
      padding: 36px 44px;
      border-radius: 12px;
      text-align: left;
      box-shadow: 0 10px 30px rgba(0,0,0,.25);
    }
    .brand-title{
      font-weight: 700;
      font-size: clamp(22px, 3.2vw, 30px);
      letter-spacing: .06em;
      text-transform: uppercase;
      margin: 0 0 18px 0;
    }
    .card h1{
      font-size: clamp(20px, 2.6vw, 26px);
      margin: 0 0 14px 0;
    }
    .cities{
      display:flex; gap:12px; flex-wrap:wrap; justify-content:flex-start;
      margin: 8px 0 16px 0;
    }
    .cities button{ background: var(--brand-600); border:0; color: var(--beige); padding:10px 14px; border-radius: 10px; cursor:pointer; }
    .rules{ margin-top: 10px; line-height: 1.5; }
    .rules .rules-title{ font-weight: 600; margin-bottom: 4px; }
    .rules .rules-lines{ white-space: pre-line; }

    table{ width:100%; border-collapse: collapse; color: var(--beige); }
    th,td{ border-bottom:1px solid rgba(255,255,255,.1); padding:6px; text-align:left; }
    th{ background: var(--brand-800); }

    /* Custom divIcon styles */
    .nabo-pin{
      display: grid; place-items:center;
      width: 30px; height: 30px; border-radius: 50%;
      background: var(--brand-800); color: white;
      border: 2px solid #2c3b31;
      box-shadow: 0 2px 6px rgba(0,0,0,.35);
      transform: translate(-15px,-15px);
      font-size: 18px; line-height: 1;
      user-select: none;
    }
    .nabo-pin svg{ width:16px; height:16px; fill:#fff; }

    /* små hjälpklasser */
    header nav button{ background:transparent; border:0; color:var(--beige); padding:6px 10px; border-radius:8px; }
    header nav button.active{ background: rgba(255,255,255,.1); }
  </style>
</head>
<body>
<div id="app">
  <header>
    <div>Geoguessr - The Nabo Way</div>
    <nav>
      <button id="tabPlay" class="active">Spela</button>
      <button id="tabBoard">Leaderboard</button>
    </nav>
  </header>

  <div id="playCol">
    <div id="map"></div>
    <div class="float-info">
      <div id="place">Ledtråd: –</div>
      <div class="toolbar">
        <button id="btnNext">Ny plats</button>
        <button id="btnEnd">Avsluta & spara resultat</button>
      </div>
      <div id="info" class="hint">Välj stad för att börja.</div>
    </div>
  </div>

  <aside class="panel" id="sideCol">
    <div class="box">
      <div><strong>Rundor</strong></div>
      <div class="hint">Klicka på kartan för att lägga en gissning. Efter varje gissning läggs en rad här.</div>
    </div>
    <div class="box">
      <table id="roundsTable">
        <thead>
          <tr>
            <th>#</th><th>Ledtråd</th><th>Stad</th><th>Avstånd</th><th>Felmarginal</th><th>Straffpoäng</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
      <div class="sum" id="summary">0 rundor – Totala straffpoäng: 0 · Snittavstånd: 0 km</div>
    </div>
    <div class="box" id="boardBox" style="display:none;">
      <div><strong id="boardTitle">Leaderboard (server)</strong></div>
      <div class="hint">Toppresultat sparas i databasen.</div>
      <table id="boardTable">
        <thead><tr><th>#</th><th>Namn</th><th>Straffpoäng</th><th>Rundor</th><th>Stad</th><th>Datum</th></tr></thead>
        <tbody></tbody>
      </table>
    </div>
  </aside>
</div>

<!-- ★ Uppdaterad overlay med större kort, rubrik och regler -->
<div class="overlay" id="overlay">
  <div class="card">
    <div class="brand-title">GEOGUESSR - THE NABO WAY</div>

    <h1>VÄLJ STAD</h1>
    <div class="cities">
      <button data-city="stockholm">Stockholm</button>
      <button data-city="goteborg">Göteborg</button>
      <button data-city="malmo">Malmö</button>
    </div>

    <div class="rules">
      <div class="rules-title">Reglerna är enkla</div>
      <div class="rules-lines">
Se ledtråden
Placera ut fastigheten på kartan
Bäst av 5
      </div>
    </div>
  </div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
  // ======= spelparametrar =======
  const ROUNDS_TOTAL = 5;

  // ======= state =======
  let selectedCity = null;
  let cityCenters = {};
  let place = null;
  let guessMarker = null, trueMarker = null, line = null;
  let locked = true; // ⛔ lås kartklick tills runda startar

  const naboGreen = "#3e4f42";

  // ======= ikoner =======
  function makeArrowIcon(deg=0){
    const html = '<div class="nabo-pin"><svg style="transform: rotate(' + deg + 'deg)" viewBox="0 0 24 24" aria-hidden="true"><path d="M12 3l5.5 9h-4v9h-3v-9h-4L12 3z"/></svg></div>';
    return L.divIcon({className: "", html, iconSize:[30,30], iconAnchor:[15,15], popupAnchor:[0,-15]});
  }
  function makeCheckIcon(){
    const html = '<div class="nabo-pin"><svg viewBox="0 0 24 24" aria-hidden="true"><path d="M9 16.2l-3.5-3.5-1.4 1.4L9 19 20.3 7.7l-1.4-1.4z"/></svg></div>';
    return L.divIcon({className: "", html, iconSize:[30,30], iconAnchor:[15,15], popupAnchor:[0,-15]});
  }

  // ======= verktyg =======
  function bearingDeg(lat1, lon1, lat2, lon2){
    const toRad = x => x * Math.PI / 180, toDeg = x => x * 180 / Math.PI;
    const φ1 = toRad(lat1), φ2 = toRad(lat2), Δλ = toRad(lon2-lon1);
    const y = Math.sin(Δλ) * Math.cos(φ2);
    const x = Math.cos(φ1)*Math.sin(φ2) - Math.sin(φ1)*Math.cos(φ2)*Math.cos(Δλ);
    return (toDeg(Math.atan2(y,x)) + 360) % 360;
  }
  function escapeHtml(s){ return String(s).replace(/[&<>\"]/g, c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[c])); }
  function setLocked(flag){ locked = flag; if(flag) map.off('click', onMapClick); else map.on('click', onMapClick); }

  // ======= karta =======
  const map = L.map('map').setView([62.0, 15.0], 5);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 19 }).addTo(map);
  map.on('click', onMapClick);

  // ======= init (städer) =======
  fetch('/api/cities').then(r=>r.json()).then(j=>{
    j.cities.forEach(c => { cityCenters[c.key] = c.center; });
  });

  // ======= overlay – välj stad =======
  document.querySelectorAll('.overlay .cities button').forEach(btn=>{
    btn.addEventListener('click', ()=>{
      selectedCity = btn.getAttribute('data-city');
      const center = cityCenters[selectedCity] || defaultCenter(selectedCity);
      map.setView(center, 11);
      document.getElementById('overlay').style.display = 'none';
      document.getElementById('info').textContent = 'Klicka på kartan för att gissa.';
      resetRounds();
      newRound();
    });
  });

  // ======= flikar =======
  document.getElementById('tabPlay').addEventListener('click', ()=>{
    document.getElementById('tabPlay').classList.add('active');
    document.getElementById('tabBoard').classList.remove('active');
    document.getElementById('playCol').style.display = '';
    document.getElementById('boardBox').style.display = 'none';
  });
  document.getElementById('tabBoard').addEventListener('click', async ()=>{
    document.getElementById('tabBoard').classList.add('active');
    document.getElementById('tabPlay').classList.remove('active');
    document.getElementById('playCol').style.display = 'none';
    document.getElementById('boardBox').style.display = '';
    await refreshLeaderboard();
  });

  function defaultCenter(k){
    if (k === 'stockholm') return [59.334, 18.063];
    if (k === 'goteborg')  return [57.707, 11.967];
    if (k === 'malmo')     return [55.605, 13.003];
    return [62, 15];
  }

  // ======= knappar =======
  document.getElementById('btnNext').addEventListener('click', ()=>{
    if (!selectedCity) { document.getElementById('info').textContent = 'Välj stad först.'; return; }
    const rounds = window._rounds || [];
    if (rounds.length >= ROUNDS_TOTAL) {
      document.getElementById('info').textContent = 'Tävlingen är klar – välj “Avsluta & spara resultat”.';
      return;
    }
    newRound();
  });

  document.getElementById('btnEnd').addEventListener('click', async ()=>{
    const rounds = window._rounds || [];
    if (rounds.length === 0) { document.getElementById('info').textContent = 'Spela minst en runda först.'; return; }
    const total = rounds.reduce((s,r)=>s+r.score, 0);
    const name = (prompt('Ditt namn för leaderboarden?') || '').trim();
    if (!name) return;

    // Spara i DB (server)
    const res = await fetch('/api/leaderboard', {
      method:'POST', headers:{'Content-Type':'application/json'},
      body: JSON.stringify({name, score: total, rounds: rounds.length, city: selectedCity})
    });
    if (res.ok) {
      document.getElementById('info').textContent = 'Resultat sparat! 👏';
      // Tillbaka till "Välj stad"
      resetToMenu();
    } else {
      document.getElementById('info').textContent = 'Kunde inte spara resultat.';
    }
  });

  // ======= rundflöde =======
  async function newRound() {
    try {
      clearViz();
      const res = await fetch('/api/round?city=' + encodeURIComponent(selectedCity));
      if (!res.ok) throw new Error('/api/round ' + res.status);
      const data = await res.json();
      if (!data.place) throw new Error('ingen plats i svaret');
      place = data.place;

      document.getElementById('place').textContent = 'Ledtråd: ' + (place.display_name || '(saknas)');
      setLocked(false); // öppna för ett (1) klick
      document.getElementById('info').textContent = 'Klicka en gång på kartan för din gissning.';
    } catch(e) {
      console.error(e);
      document.getElementById('info').textContent = 'Kunde inte ladda ny plats (' + e.message + ').';
    }
  }

  function clearViz() {
    if (guessMarker) { map.removeLayer(guessMarker); guessMarker = null; }
    if (trueMarker)  { map.removeLayer(trueMarker);  trueMarker  = null; }
    if (line)        { map.removeLayer(line);        line        = null; }
  }

  async function onMapClick(e) {
    if (locked || !selectedCity || !place) return;
    try {
      setLocked(true);            // ⛔ lås direkt efter första klicket
      clearViz();

      guessMarker = L.marker(e.latlng, {icon: makeArrowIcon(0)})
        .addTo(map).bindPopup('Din gissning').openPopup();

      const res = await fetch('/api/guess/map?city=' + encodeURIComponent(selectedCity), {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ place_id: place.id, lat: e.latlng.lat, lon: e.latlng.lng })
      });
      const result = await res.json();

      const brg = bearingDeg(e.latlng.lat, e.latlng.lng, result.solution.lat, result.solution.lon);
      guessMarker.setIcon( makeArrowIcon(brg) );

      trueMarker = L.marker([result.solution.lat, result.solution.lon], {icon: makeCheckIcon()})
        .addTo(map).bindPopup('Facit: ' + [place.street, place.ort].filter(Boolean).join(', '));

      line = L.polyline([[e.latlng.lat, e.latlng.lng], [result.solution.lat, result.solution.lon]],
        { color: naboGreen, weight: 4 }).addTo(map);

      const distanceKm  = Number(result.distance_km).toFixed(1);
      const errorMargin = Math.round(result.distance_km);
      document.getElementById('info').textContent =
        'Avstånd: ' + distanceKm + ' km | Straffpoäng: ' + result.score;

      addRoundRow(place.display_name || '(okänd)', distanceKm, errorMargin, result.score);

      const rounds = window._rounds || [];
      if (rounds.length >= ROUNDS_TOTAL) {
        document.getElementById('info').textContent += ' · Tävlingen är klar – välj “Avsluta & spara resultat”.';
      }
    } catch(e) {
      console.error(e);
      setLocked(false);
      document.getElementById('info').textContent = 'Tekniskt fel: ' + e;
    }
  }

  function addRoundRow(clue, distanceKm, errorMargin, score) {
    window._rounds = window._rounds || [];
    const rounds = window._rounds;
    if (rounds.length >= ROUNDS_TOTAL) return;    // skydd

    rounds.push({ clue, distanceKm: Number(distanceKm), score, city: selectedCity });
    const tb = document.querySelector('#roundsTable tbody');
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${rounds.length}</td>
      <td>${escapeHtml(clue)}</td>
      <td>${escapeHtml(CITY_LABELS[selectedCity] || selectedCity || "-")}</td>
      <td>${distanceKm}</td>
      <td>${errorMargin}</td>
      <td>${score}</td>
    `;
    tb.appendChild(tr);
    updateSummary(rounds);
  }

  function updateSummary(rounds) {
    if (!rounds || rounds.length === 0) {
      document.getElementById('summary').textContent = '0 rundor – Totala straffpoäng: 0 · Snittavstånd: 0 km';
      return;
    }
    const totalPoints = rounds.reduce((s,r)=>s+r.score, 0);
    const avgDist = (rounds.reduce((s,r)=>s+r.distanceKm, 0) / rounds.length).toFixed(1);
    document.getElementById('summary').textContent =
      `${rounds.length} rundor – Totala straffpoäng: ${totalPoints} · Snittavstånd: ${avgDist} km`;
  }

  function resetRounds(){
    window._rounds = [];
    document.querySelector('#roundsTable tbody').innerHTML = '';
    updateSummary(window._rounds);
  }

  // ======= leaderboard (server) =======
  async function refreshLeaderboard() {
    const res = await fetch('/api/leaderboard?limit=20&order=best');
    if (!res.ok) return;
    const data = await res.json();
    const tb = document.querySelector('#boardTable tbody');
    tb.innerHTML = "";
    data.items.forEach((row, idx) => {
      const dateStr = row.created_at ? String(row.created_at).replace('T',' ').replace('Z','') : '';
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${idx+1}</td>
        <td>${escapeHtml(row.name)}</td>
        <td>${row.score}</td>
        <td>${row.rounds}</td>
        <td>${escapeHtml(row.city || "-")}</td>
        <td>${escapeHtml(dateStr)}</td>
      `;
      tb.appendChild(tr);
    });
    document.getElementById('boardTitle').textContent = 'Leaderboard (server)';
  }

  // Tillbaka till meny efter sparat resultat
  function resetToMenu(){
    setLocked(true);
    clearViz();
    selectedCity = null;
    document.getElementById('place').textContent = 'Ledtråd: –';
    document.getElementById('info').textContent = 'Välj stad för att börja.';
    resetRounds();
    document.getElementById('playCol').style.display = '';
    document.getElementById('boardBox').style.display = 'none';
    document.getElementById('tabPlay').classList.add('active');
    document.getElementById('tabBoard').classList.remove('active');
    document.getElementById('overlay').style.display = 'flex'; // visa "Välj stad"
  }

  const CITY_LABELS = { stockholm:"Stockholm", goteborg:"Göteborg", malmo:"Malmö" };
</script>
</body>
</html>
